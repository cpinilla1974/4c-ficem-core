# Sesión 2025-12-17: Admin App y Gestión de Usuarios

## Objetivo
Crear una aplicación de administración web con Streamlit para gestionar usuarios y procesos del sistema FICEM CORE.

## Implementaciones

### 1. Aplicación Streamlit (admin_app.py)

Se creó una interfaz web completa para administradores FICEM con las siguientes características:

**Estructura**:
- Login con autenticación JWT
- Sidebar con información del usuario y menú
- 4 secciones principales: Dashboard, Usuarios, Procesos MRV, Submissions

**Funcionalidades implementadas**:
- Autenticación contra API FastAPI
- Gestión completa de usuarios (listar, filtrar, crear)
- Interfaz para procesos MRV (placeholder)
- Interfaz para submissions (placeholder)

**Tecnologías**:
- Streamlit 1.52.1
- Requests para consumir API REST
- JWT token storage en session_state

### 2. API REST - Gestión de Usuarios

Se implementó el módulo completo de gestión de usuarios en `api/routes/usuarios.py`:

**Endpoints**:
- `GET /api/v1/usuarios` - Listar con filtros (país, rol, activo)
- `GET /api/v1/usuarios/{id}` - Obtener usuario específico
- `POST /api/v1/usuarios` - Crear nuevo usuario
- `PUT /api/v1/usuarios/{id}` - Actualizar usuario
- `DELETE /api/v1/usuarios/{id}` - Desactivar usuario (soft delete)

**Seguridad**:
- Requiere autenticación JWT en todos los endpoints
- Solo usuarios ROOT y ADMIN_PROCESO pueden gestionar usuarios
- Validación de roles y permisos
- Hash de contraseñas con bcrypt

**Schemas Pydantic**:
- `UsuarioResponse` - Respuesta GET
- `UsuarioCreate` - Creación POST
- `UsuarioUpdate` - Actualización PUT

### 3. Script de Creación de Usuario Admin

Se creó `scripts/crear_usuario_admin.py` para inicializar el sistema:

**Funcionalidad**:
- Crea usuario ROOT inicial (`admin@ficem.org` / `admin123`)
- Opcionalmente crea usuarios de ejemplo para testing
- Verifica que no existan usuarios duplicados
- Hash seguro de contraseñas

**Usuarios de ejemplo**:
- Coordinador Perú: `coord.peru@asocem.org`
- Coordinador Colombia: `coord.colombia@ficem.org`
- Admin Procesos: `admin.proceso@ficem.org`

### 4. Actualización de Documentación

Se actualizaron los siguientes archivos:

**README.md**:
- Agregado paso de creación de usuario admin
- Documentados todos los endpoints implementados
- Agregada sección de Admin App Streamlit

**QUICKSTART.md**:
- Actualizado proceso de inicialización
- Agregadas instrucciones para ejecutar Streamlit
- Documentado uso de Admin App

**.env.example**:
- Agregada variable `API_URL` para Streamlit

## Estructura de Archivos Creados/Modificados

```
4c-ficem-core/
├── admin_app.py                          # Nueva - App Streamlit
├── api/
│   ├── main.py                           # Modificada - registrar ruta usuarios
│   └── routes/
│       └── usuarios.py                   # Nueva - CRUD usuarios
├── scripts/
│   └── crear_usuario_admin.py           # Nueva - setup inicial
├── README.md                             # Actualizada
├── QUICKSTART.md                         # Actualizada
├── .env.example                          # Actualizada
└── docs/
    └── sesiones/
        └── 2025-12-17.md                # Esta sesión
```

## Flujo de Trabajo Implementado

### Inicialización del Sistema
1. Configurar variables de entorno
2. Ejecutar migraciones Alembic
3. Crear usuario ROOT con script
4. Iniciar API FastAPI
5. (Opcional) Iniciar Admin App Streamlit

### Gestión de Usuarios
1. Login en Admin App con usuario ROOT
2. Navegar a sección "Usuarios"
3. Ver lista de usuarios existentes (filtrar por país/rol)
4. Crear nuevos usuarios con diferentes roles
5. Sistema valida permisos y crea usuario en BD

## Decisiones Técnicas

### Streamlit vs Frontend tradicional
- **Decisión**: Usar Streamlit para Admin App
- **Razón**:
  - Desarrollo rápido para operadores FICEM
  - No requiere React/Next.js para funcionalidad básica
  - Los frontends de país (4c-peru) seguirán usando Next.js
  - Streamlit es ideal para herramientas internas

### Soft Delete de Usuarios
- **Decisión**: No eliminar usuarios, solo desactivar
- **Razón**:
  - Mantener integridad referencial
  - Auditoría de quién creó qué submission
  - Posibilidad de reactivar usuarios

### JWT en Streamlit
- **Decisión**: Almacenar token en `st.session_state`
- **Razón**:
  - Simple y efectivo para app interna
  - No requiere cookies o localStorage
  - Token se pierde al cerrar sesión/browser (seguro)

## Comandos de Ejecución

### Iniciar servicios
```bash
# Terminal 1 - API
source venv/bin/activate
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

# Terminal 2 - Streamlit
source venv/bin/activate
streamlit run admin_app.py --server.port 8501
```

### Crear usuarios
```bash
# Usuario ROOT
python scripts/crear_usuario_admin.py

# Usuarios de ejemplo
echo "s" | python scripts/crear_usuario_admin.py
```

## URLs de Acceso

- **API Swagger**: http://localhost:8000/docs
- **Admin App**: http://localhost:8501
- **Login**: `admin@ficem.org` / `admin123`

## Próximos Pasos

1. Implementar endpoints de Procesos MRV
2. Implementar endpoints de Submissions
3. Conectar Admin App con endpoints de Procesos/Submissions
4. Agregar estadísticas en Dashboard
5. Implementar cambio de contraseña
6. Agregar logs de auditoría

## Notas

- La API se recarga automáticamente (--reload)
- Streamlit detecta cambios en admin_app.py
- Todos los endpoints requieren autenticación JWT
- Usuario ROOT tiene acceso total sin restricciones

---

**Participantes**: Carlos Pinilla (usuario), Claude (asistente)
**Duración**: ~2 horas
**Estado**: Completado ✅