# Sesión 2025-12-10: Arquitectura Motor de Procesos Multi-País

## Contexto

Análisis de necesidades para 4c-peru reveló que múltiples países tendrán múltiples protocolos MRV diferentes (PRODUCE, MRV HR, 4C nacional, etc.). Se requiere solución escalable y administrable desde FICEM CORE.

## Problema

- **Actual**: Endpoints hardcoded para flujo único de carga/validación
- **Necesidad**: Múltiples procesos por país (PRODUCE Perú, MRV HR Colombia, etc.)
- **Requerimiento**: Configuración dinámica sin deploy de código

## Decisión: Motor de Procesos Multi-País

### Arquitectura Registry Pattern

Sistema de procesos configurables donde:
- Admin FICEM registra nuevos procesos vía API
- Cada proceso define su template, validaciones, workflow y cálculos
- Frontends consumen APIs genéricas adaptadas por proceso_id
- BD usa esquemas separados por país (ya existente)

### Modelo de Datos

#### Tabla: `procesos_mrv`
```sql
CREATE TABLE procesos_mrv (
    id VARCHAR(100) PRIMARY KEY,              -- 'produce-peru-2024'
    pais_iso CHAR(2) NOT NULL,                -- 'PE', 'CO', 'MX'
    tipo VARCHAR(50) NOT NULL,                -- 'PRODUCE', 'MRV_HR', '4C_NACIONAL'
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    ciclo VARCHAR(20),                         -- '2024', '2024-2025'
    estado VARCHAR(20) DEFAULT 'activo',       -- borrador|activo|cerrado|archivado
    config JSONB NOT NULL,                     -- Configuración completa
    created_by INTEGER REFERENCES usuarios(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT unique_proceso_ciclo UNIQUE (pais_iso, tipo, ciclo)
);

CREATE INDEX idx_procesos_pais ON procesos_mrv(pais_iso);
CREATE INDEX idx_procesos_estado ON procesos_mrv(estado);
```

**Estructura `config` (JSONB)**:
```json
{
  "template_version": "produce_peru_v2.1.xlsx",
  "hojas_requeridas": ["Cemento", "Concreto", "Clinker"],

  "validaciones": [
    {"tipo": "estructura", "nivel": "error"},
    {"tipo": "rangos", "nivel": "warning", "params": {...}},
    {"tipo": "consistencia_gcca", "nivel": "error"}
  ],

  "workflow_steps": [
    {"step": "borrador", "roles": ["empresa"]},
    {"step": "enviado", "roles": ["empresa"], "notificar": ["coordinador"]},
    {"step": "en_revision", "roles": ["coordinador_pais"]},
    {"step": "aprobado", "roles": ["coordinador_pais"], "triggers": ["ejecutar_calculos"]},
    {"step": "publicado", "roles": ["ficem"], "visible": true}
  ],

  "deadline_envio": "2025-03-31",
  "deadline_revision": "2025-04-30",

  "calculos_habilitados": ["gcca", "bandas", "benchmarking"],
  "esquema_bd": "peru_data"
}
```

#### Tabla: `submissions`
```sql
CREATE TABLE submissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    proceso_id VARCHAR(100) REFERENCES procesos_mrv(id),
    empresa_id INTEGER NOT NULL,
    planta_id INTEGER,
    usuario_id INTEGER REFERENCES usuarios(id),

    estado_actual VARCHAR(50) NOT NULL,        -- borrador|enviado|en_revision|aprobado|rechazado
    workflow_history JSONB DEFAULT '[]',       -- Historial de estados

    archivo_excel JSONB,                       -- {url, hash, size_bytes}
    datos_extraidos JSONB,                     -- Datos parseados del Excel
    validaciones JSONB,                        -- Resultados validación
    comentarios JSONB DEFAULT '[]',            -- Comentarios de revisión
    resultados_calculos JSONB,                 -- Resultados GCCA, bandas

    created_at TIMESTAMP DEFAULT NOW(),
    submitted_at TIMESTAMP,
    reviewed_at TIMESTAMP,
    approved_at TIMESTAMP,

    CONSTRAINT fk_empresa FOREIGN KEY (empresa_id) REFERENCES empresas(id)
);

CREATE INDEX idx_submissions_proceso ON submissions(proceso_id);
CREATE INDEX idx_submissions_empresa ON submissions(empresa_id);
CREATE INDEX idx_submissions_estado ON submissions(estado_actual);
```

### APIs REST

#### Gestión de Procesos (Admin FICEM)
```
POST   /api/v1/procesos                          # Crear proceso
GET    /api/v1/procesos?pais=PE&activo=true      # Listar procesos
GET    /api/v1/procesos/{proceso_id}             # Detalle proceso
PUT    /api/v1/procesos/{proceso_id}             # Actualizar config
PATCH  /api/v1/procesos/{proceso_id}/estado      # Activar/pausar/cerrar
```

#### Templates
```
GET    /api/v1/procesos/{proceso_id}/template    # Descargar Excel template
POST   /api/v1/templates/generate                # Generar template dinámico
```

#### Workflow (Empresas/Coordinadores)
```
POST   /api/v1/procesos/{proceso_id}/submissions       # Crear envío
GET    /api/v1/procesos/{proceso_id}/submissions       # Listar envíos
GET    /api/v1/submissions/{id}                        # Detalle envío
POST   /api/v1/submissions/{id}/upload                 # Subir Excel
POST   /api/v1/submissions/{id}/validate               # Validar
POST   /api/v1/submissions/{id}/submit                 # Enviar a revisión
POST   /api/v1/submissions/{id}/review                 # Aprobar/rechazar
GET    /api/v1/submissions/{id}/results                # Resultados cálculos
```

#### Reportes
```
GET    /api/v1/procesos/{proceso_id}/report/agregado   # Consolidado país
GET    /api/v1/procesos/{proceso_id}/export/produce    # Formato PRODUCE
GET    /api/v1/procesos/{proceso_id}/export/4c         # Formato 4C
GET    /api/v1/reportes/multi-pais?procesos[]=...      # Multi-país
```

## Ventajas

| Aspecto | Beneficio |
|---------|-----------|
| **Escalabilidad** | Cada país puede tener N procesos sin cambios de código |
| **Configurabilidad** | Admin FICEM define procesos vía UI/API |
| **Reutilización** | Mismo código sirve PRODUCE, MRV HR, 4C |
| **Aislamiento** | Esquemas PostgreSQL separados por país |
| **Auditoría** | `workflow_history` registra todos los cambios |
| **Flexibilidad** | Triggers configurables (aprobar → calcular) |
| **Multi-protocolo** | Diferentes exportadores por tipo proceso |

## Migración desde Sistema Actual

### Fase 1: Infraestructura (Esta sesión)
- [x] Actualizar CLAUDE.md con política de sesiones locales
- [ ] Crear tablas `procesos_mrv` y `submissions`
- [ ] Migrar modelos SQLAlchemy
- [ ] Crear endpoints básicos `/procesos` y `/submissions`

### Fase 2: Refactor Endpoints Actuales
- [ ] Deprecar `/uploads` → usar `/submissions`
- [ ] Mantener compatibilidad temporal con frontends
- [ ] Migrar datos existentes a modelo submissions

### Fase 3: Workflow Engine
- [ ] Implementar máquina de estados configurable
- [ ] Sistema de notificaciones (email/webhook)
- [ ] Triggers automáticos

### Fase 4: Templates Dinámicos
- [ ] Generador de Excel por config
- [ ] Validaciones plugables
- [ ] Exportadores por tipo proceso

## Próximos Pasos

1. Crear scripts de migración BD
2. Implementar modelos SQLAlchemy
3. Desarrollar endpoints CRUD `/procesos`
4. Crear primer proceso de prueba (PRODUCE Perú)
5. Actualizar documentación OpenAPI

## Referencias

- Repo ecosistema: https://github.com/cpinilla1974/latam-3c
- Análisis original: Conversación usuario sobre 4c-peru procesos